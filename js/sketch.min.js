/**
 * Copyright (C) 2012 by Justin Windle
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */// requestAnimationFrame polyfill by Erik MÃ¶ller
// Fixes from Paul Irish and Tino Zijdel
// @see http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// @see http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
(function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),i=window.setTimeout(function(){t(n+r)},r);return e=n+r,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})})(),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=[].slice,n=t.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i?this:e||{},n.concat(t.call(arguments)))};return s.prototype=this.prototype,s});var sketch=function(){function l(t){t=c(t||{},s);var n="sketch-"+e++,i=document.createElement("canvas");switch(t.type){case sketch.WEB_GL:try{r=i.getContext("webgl",t)}catch(a){}try{r=r||i.getContext("experimental-webgl",t)}catch(a){}if(!r)throw"WebGL not supported";break;case sketch.CANVAS:try{r=i.getContext("2d",t)}catch(a){}if(!r)throw"Canvas not supported";break;default:i=r=document.createElement("div")}return i.className="sketch",i.id=n,t.container.appendChild(i),c(self,o),c(r,t),p(),v(),c(r,u),r.autostart&&setTimeout(r.start,0),r}function c(e,t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e}function h(e){var t={};for(var n in e)typeof e[n]=="function"?t[n]=function(t){return function(){t.call(e,arguments)}}(e[n]):t[n]=e[n];return t}function p(){function n(t){return e[t]||String.fromCharCode(t)}function i(e){r.oMouseX=r.mouseX,r.oMouseY=r.mouseY,r.mouseX=e.x,r.mouseY=e.y}function o(e){var t,n=h(e);n.original=e;for(var i=r.canvas,o=oy=0;i;i=i.offsetParent)o+=i.offsetLeft,oy+=i.offsetTop;if(n.touches&&!!n.touches.length)for(var u=n.touches.length-1,a;u>=0;u--)a=n.touches[u],a.x=a.pageX-o,a.y=a.pageY-oy,t=s[u]||a,a.deltaX=a.x-t.x,a.deltaY=a.y-t.x,a.oldX=t.x,a.oldY=t.y,s[u]=h(a);else n.x=n.pageX-o,n.y=n.pageY-oy,t=s.mouse||n,n.deltaX=n.x-t.x,n.deltaY=n.y-t.y,n.oldX=t.x,n.oldY=t.y,s.mouse=n;return n}function l(e){e.preventDefault(),e=o(e),r.touches=e.touches,i(r.touches[0]),r.touchstart&&r.touchstart(e)}function c(e){e=o(e),r.touches=e.touches,i(r.touches[0]),r.touchmove&&r.touchmove(e),r.mousemove&&r.mousemove(e)}function p(e){e=o(e);if(!e.touches.length)s={};else for(var t in s)e.touches[t]||delete s[t];r.touchend&&r.touchend(e)}function d(e){e=o(e),r.mouseover&&r.mouseover(e)}function m(e){e=o(e),r.dragging||(f(r.canvas,"mousemove",g),f(r.canvas,"mouseup",b),a(document,"mousemove",g),a(document,"mouseup",b),r.dragging=!0),r.touches=[e],r.mousedown&&r.mousedown(e)}function g(e){e=o(e),i(e),r.touches=[e],r.mousemove&&r.mousemove(e),r.touchmove&&r.touchmove(e)}function y(e){e=o(e),r.mouseout&&r.mouseout(e)}function b(e){e=o(e),r.dragging&&(f(document,"mousemove",g),f(document,"mouseup",b),a(r.canvas,"mousemove",g),a(r.canvas,"mouseup",b),r.dragging=!1),delete s.mouse,r.mouseup&&r.mouseup(e)}function w(e){e=o(e),r.click&&r.click(e)}function E(e){r.keys[n(e.keyCode)]=!0,r.keys[e.keyCode]=!0,r.keydown&&r.keydown(e)}function S(e){r.keys[n(e.keyCode)]=!1,r.keys[e.keyCode]=!1,r.keyup&&r.keyup(e)}var e={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};for(var t in e)u.keys[e[t]]=!1;var s={};a(r.canvas,"touchstart",l),a(r.canvas,"touchmove",c),a(r.canvas,"touchend",p),a(r.canvas,"mouseover",d),a(r.canvas,"mousedown",m),a(r.canvas,"mousemove",g),a(r.canvas,"mouseout",y),a(r.canvas,"mouseup",b),a(r.canvas,"click",w),a(document,"keydown",E),a(document,"keyup",S),a(window,"resize",v)}function d(e){r.dt=(e=e||+(new Date))-r.now,r.millis+=r.dt,r.now=e,r.update&&r.update(r.millis,r.dt,r.now),r.autoclear&&r.clear(),r.draw&&r.draw(r),i=requestAnimationFrame(d)}function v(e){r.fullscreen?(r.height=r.canvas.height=window.innerHeight,r.width=r.canvas.width=window.innerWidth):(r.canvas.height=r.height,r.canvas.width=r.width),r.resize&&r.resize()}var e=0,t="canvas",n="web-gl",r,i=-1,s={fullscreen:!0,autostart:!0,autoclear:!0,container:document.body,type:t},o={PI:Math.PI,TWO_PI:Math.PI*2,HALF_PI:Math.PI/2,QUATER_PI:Math.PI/4,sin:Math.sin,cos:Math.cos,tan:Math.tan,pow:Math.pow,exp:Math.exp,min:Math.min,max:Math.max,sqrt:Math.sqrt,atan:Math.atan,atan2:Math.atan2,ceil:Math.ceil,round:Math.round,floor:Math.floor,random:function(e,t){return e&&typeof e.length=="number"&&!!e.length?e[Math.floor(Math.random()*e.length)]:(typeof t!="number"&&(t=e||1,e=0),e+Math.random()*(t-e))}},u={keys:{},millis:0,now:0,dt:0,mouseX:0,mouseY:0,oMouseX:0,oMouseY:0,touches:[],dragging:!1};u.start=function(){r.setup&&r.setup(),d()},u.stop=function(){cancelAnimationFrame(i)},u.clear=function(){r.canvas&&(r.canvas.width=r.canvas.width)};var a=function(){if(window.addEventListener)return function(e,t,n){e.addEventListener(t,n,!1)};if(window.attachEvent)return function(e,t,n){e.attachEvent("on"+t,n)};el["on"+ev]=fn}(),f=function(){if(window.removeEventListener)return function(e,t,n){e.removeEventListener(t,n,!1)};if(window.detachEvent)return function(e,t,n){e.detachEvent("on"+t,n)};el["on"+ev]=null}();return{CANVAS:t,WEB_GL:n,create:l}}();
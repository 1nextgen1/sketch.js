/**
 * Copyright (C) 2012 by Justin Windle
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//**
 * --------------------------------------------------
 *
 *  A simple base for JavaScript creative coding
 *  experiments or sketches...
 *
 * --------------------------------------------------
 */var Sketch;Sketch=function(){function e(e){this._extend(window,this._globals),this.id="sketch-"+floor(random(16777215)),e=this._extend(e||{},this._defaults),this._extend(this,e),this.autostart&&this.start()}return function(){for(var e=0,t=["ms","moz","webkit","o"],n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var n=(new Date).getTime(),r=Math.max(0,16-(n-e)),i=window.setTimeout(function(){t(n+r)},r);return e=n+r,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=[].slice,n=t.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i?this:e||{},n.concat(t.call(arguments)))};return s.prototype=this.prototype,s}),e.CANVAS="canvas",e.prototype={_globals:{PI:Math.PI,TWO_PI:Math.PI*2,HALF_PI:Math.PI/2,QUATER_PI:Math.PI/4,sin:Math.sin,cos:Math.cos,tan:Math.tan,pow:Math.pow,exp:Math.exp,min:Math.min,max:Math.max,sqrt:Math.sqrt,atan:Math.atan,atan2:Math.atan2,ceil:Math.ceil,round:Math.round,floor:Math.floor,random:function(e,t){return e&&typeof e.length=="number"&&!!e.length?e[Math.floor(Math.random()*e.length)]:(typeof t!="number"&&(t=e||1,e=0),e+Math.random()*(t-e))}},_defaults:{type:e.CANVAS,fullscreen:!0,autoclear:!0,autostart:!0,container:document.body,setup:function(){},draw:function(e,t){},resize:function(e,t){},touchstart:function(e){},touchmove:function(e){},mousemove:function(e){},click:function(e){},keydown:function(e){},keyup:function(e){}},start:function(){this._bindAll(),this.currentTime=+(new Date),this.previousTime=this.currentTime,this.mouseX=0,this.mouseY=0,this.oMouseX=0,this.oMouseY=0,this.touches=[],this.ALT=!1,this.CTRL=!1,this.SHIFT=!1,this.domElement=document.createElement("div"),this.domElement.id=this.id,this.domElement.className="sketch",this.container.appendChild(this.domElement);switch(this.type){case e.CANVAS:if(!window.CanvasRenderingContext2D)throw new Error("CanvasRenderingContext2D not supported");this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.domElement.appendChild(this.canvas)}this._addEvent(this.domElement,"click",this._onClick),this._addEvent(this.domElement,"mousemove",this._onMouseMove),this._addEvent(this.domElement,"touchstart",this._onTouchStart),this._addEvent(this.domElement,"touchmove",this._onTouchMove),this._addEvent(window,"keydown",this._onKeyDown),this._addEvent(window,"keyup",this._onKeyUp),this._addEvent(window,"resize",this._onResize);if(this.stats)if(typeof Stats=="function")this._initStats();else{var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src","https://raw.github.com/mrdoob/stats.js/d5f5aa40a24a6d5667ecbcef20c13c75cf236bcd/build/Stats.js"),t.onload=this.onreadystatechange=this._initStats,document.body.appendChild(t)}this._onResize(),this.setup(),this._update(this.currentTime)},clear:function(){switch(this.type){case e.CANVAS:this.canvas.width=this.canvas.width}},destroy:function(){this._removeEvent(this.domElement,"click",this._onClick),this._removeEvent(this.domElement,"mousemove",this._onMouseMove),this._removeEvent(this.domElement,"touchstart",this._onTouchStart),this._removeEvent(this.domElement,"touchmove",this._onTouchMove),this._removeEvent(window,"keydown",this._onKeyDown),this._removeEvent(window,"keyup",this._onKeyUp),this._removeEvent(window,"resize",this._onResize)},_extend:function(e,t){for(var n in t)!e.hasOwnProperty(n)&&t.hasOwnProperty(n)&&(e[n]=t[n]);return e},_bindAll:function(e,t){e=e||this,t=t||this;for(var n in e)typeof e[n]=="function"&&(e[n]=e[n].bind(t))},_addEvent:function(e,t,n){window.addEventListener?e.addEventListener(t,n,!1):window.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n},_removeEvent:function(){window.removeEventListener?el.removeEventListener(ev,fn,!1):window.detachEvent?el.detachEvent("on"+ev,fn):el["on"+ev]=null},_initStats:function(){typeof Stats=="function"&&(this._stats=new Stats,this._stats.setMode(0),this._stats.domElement.style.position="absolute",this._stats.domElement.style.right="10px",this._stats.domElement.style.top="10px",document.body.appendChild(this._stats.domElement))},_setMouse:function(e,t){this.touches[0]={x:e,y:t},this.oMouseX=this.mouseX,this.oMouseY=this.mouseY,this.mouseX=e,this.mouseY=t},_getOffset:function(e){var t=0,n=0;while(e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop))t+=e.offsetLeft-e.scrollLeft,n+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:n}},_update:function(e){this._stats&&this._stats.begin(),this.previousTime=this.currentTime,this.currentTime=e,this.autoclear&&this.clear(),this.draw(this.ctx,this.currentTime-this.previousTime),requestAnimationFrame(this._update),this._stats&&this._stats.end()},_onResize:function(t){this.fullscreen?(this.width=window.innerWidth,this.height=window.innerHeight):(this.width=this.width,this.height=this.height);switch(this.type){case e.CANVAS:this.canvas.width=this.width,this.canvas.height=this.height}this.domElement.style.width=this.width,this.domElement.style.height=this.height,this.resize(this.width,this.height)},_onTouchStart:function(e){this.touchstart(e)},_onClick:function(e){this.click(e)},_onMouseMove:function(e){var t=this._getOffset(this.domElement);this._setMouse(e.clientX-t.x,e.clientY-t.y),this.mousemove(e)},_onTouchMove:function(e){e.preventDefault();var t,n=this._getOffset(this.domElement),r,i;this.touches=e.touches;for(r=0,i=e.touches.length;r<i;r++)t=this.touches[r],t.x=t.clientX-n.x,t.y=t.clientY-n.y;t=this.touches[0],this._setMouse(t.x,t.y),this.touchmove(e),this.mousemove(e)},_onKeyDown:function(e){this.key=e.keyCode,this.ALT=e.altKey,this.CTRL=e.ctrlKey||e.metaKey,this.SHIFT=e.shiftKey,this.keydown(e)},_onKeyUp:function(e){this.key=null,this.ALT=this.CTRL=this.SHIFT=!1,this.keyup(e)}},e}();